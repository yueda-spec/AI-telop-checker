<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIãƒ†ãƒ­ãƒƒãƒ—ãƒã‚§ãƒƒã‚«ãƒ¼</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        body { background-color: #f0f2f5; padding-top: 2rem; padding-bottom: 2rem; font-family: "Helvetica Neue", Arial, sans-serif; }
        .main-container { max-width: 800px; margin: 0 auto; background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.12); }
        .footer-info { margin-top: 3rem; padding-top: 1.5rem; border-top: 1px solid #eee; font-size: 0.85rem; color: #6c757d; }
        .footer-section-title { font-weight: bold; margin-bottom: 0.5rem; color: #343a40; display: flex; align-items: center; }
        .drop-zone { border: 2px dashed #dee2e6; border-radius: 8px; padding: 40px 20px; text-align: center; background: #f8f9fa; transition: all 0.2s; cursor: pointer; position: relative; }
        .drop-zone.dragover { border-color: #0d6efd; background: #e7f1ff; transform: scale(1.02); }
        .drop-zone p { pointer-events: none; }
        .spec-info { background-color: #e9ecef; border-left: 4px solid #6c757d; padding: 10px 15px; font-size: 0.85rem; color: #495057; margin-bottom: 15px; border-radius: 0 4px 4px 0; }
        .spec-info ul { margin: 0; padding-left: 1.2rem; }
    </style>
</head>
<body>

<div class="main-container">
    <h3 class="mb-4 text-center fw-bold text-dark">AIãƒ†ãƒ­ãƒƒãƒ—ãƒã‚§ãƒƒã‚«ãƒ¼</h3>
    
    <div class="alert alert-primary py-3 mb-4">
        <div class="d-flex align-items-center mb-1">
            <span class="fs-4 me-2">ğŸ¤–</span>
            <h6 class="alert-heading fw-bold mb-0">æ©Ÿèƒ½æ¦‚è¦</h6>
        </div>
        <p class="mb-0 ms-1 small">
            è¤‡æ•°ã®ãƒ†ãƒ­ãƒƒãƒ—ç”»åƒï¼ˆPNG/JPGï¼‰ã‚’èª­ã¿è¾¼ã‚“ã§1æœ¬ã®å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã«çµåˆã—ã¾ã™ã€‚<br>
            ä½œæˆã•ã‚ŒãŸå‹•ç”»ã‚’AIï¼ˆGeminiï¼‰ã«èª­ã¿è¾¼ã¾ã›ã‚‹ã“ã¨ã§ã€<strong>èª¤å­—è„±å­—ã‚„å›ºæœ‰åè©ã®èª¤ã‚Šã‚’è‡ªå‹•ã§ä¸€æ‹¬ãƒã‚§ãƒƒã‚¯</strong>ã§ãã¾ã™ã€‚
        </p>
    </div>
    
    <div class="mb-4">
        <label class="form-label fw-bold">1. ãƒ†ãƒ­ãƒƒãƒ—ç”»åƒé¸æŠ (PNG/JPG)</label>
        <div class="drop-zone" id="drop-zone">
            <p class="fs-5 text-muted mb-1">ã“ã“ã«ç”»åƒã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</p>
            <p class="small text-muted mb-3">ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</p>
            <input type="file" class="form-control visually-hidden" id="telop-uploader" accept="image/*" multiple>
            <button class="btn btn-outline-primary btn-sm" onclick="document.getElementById('telop-uploader').click()">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</button>
            <div id="file-count" class="mt-3 fw-bold text-primary"></div>
        </div>
        <div class="form-text mt-2 text-end">â€»ãƒ•ã‚¡ã‚¤ãƒ«åé †ï¼ˆæ˜‡é †ï¼‰ã§çµåˆã•ã‚Œã¾ã™ã€‚</div>
    </div>

    <div class="spec-info">
        <strong>âš™ï¸ å‡ºåŠ›è¨­å®š (GitHub Pages æœ€çµ‚ä¿®æ­£ç‰ˆ):</strong>
        <ul class="mt-1">
            <li>ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆï¼š1fps (1æšã«ã¤ã1ç§’è¡¨ç¤º)</li>
            <li>è§£åƒåº¦ï¼š<strong>1920x1080 å›ºå®š (é»’å¸¯ä»˜ã)</strong></li>
            <li>å‹•ä½œãƒ¢ãƒ¼ãƒ‰ï¼šã‚·ãƒ³ã‚°ãƒ«ã‚¹ãƒ¬ãƒƒãƒ‰ (ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯¾ç­–æ¸ˆ)</li>
        </ul>
    </div>

    <button id="telop-convert-btn" class="btn btn-warning w-100 py-3 fw-bold text-dark fs-5 shadow-sm">å‹•ç”»ã‚’ä½œæˆ (MP4)</button>
    
    <div id="telop-progress-bar" class="progress mt-3" style="display:none; height: 25px;">
        <div class="progress-bar progress-bar-striped progress-bar-animated bg-warning text-dark fw-bold" role="progressbar" style="width: 0%">0%</div>
    </div>
    
    <div class="card mt-4 shadow-sm">
        <div class="card-header bg-light fw-bold">ä½œæˆçµæœ</div>
        <div id="telop-result-area" class="card-body text-center p-4">
            <div class="text-muted py-4">ã“ã“ã«çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
        </div>
    </div>
    
    <div class="footer-info">
        <div class="row">
            <div class="col-md-12 mb-3">
                <div class="footer-section-title text-success">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-shield-lock-fill me-2" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 0c-.69 0-1.843.265-2.928.56-1.11.3-2.229.655-2.887.87a1.54 1.54 0 0 0-1.044 1.262c-.596 4.477.787 7.795 2.465 9.99a11.777 11.777 0 0 0 2.517 2.453c.386.273.744.482 1.048.625.28.132.581.24.829.24s.548-.108.829-.24a7.159 7.159 0 0 0 1.048-.625 11.775 11.775 0 0 0 2.517-2.453c1.678-2.195 3.061-5.513 2.465-9.99a1.541 1.541 0 0 0-1.044-1.263 62.467 62.467 0 0 0-2.887-.87C9.843.266 8.69 0 8 0zm0 5a1.5 1.5 0 0 1 .5 2.915l.385 1.99a.5.5 0 0 1-.491.595h-.788a.5.5 0 0 1-.49-.595l.384-1.99A1.5 1.5 0 0 1 8 5z"/></svg>
                    ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼
                </div>
                <p class="mb-0">æœ¬ãƒ„ãƒ¼ãƒ«ã¯ã€ã™ã¹ã¦ã®å¤‰æ›å‡¦ç†ã‚’<strong>ãƒ–ãƒ©ã‚¦ã‚¶å†…ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒï¼‰</strong>ã§å®Œçµã—ã¦è¡Œã„ã¾ã™ã€‚</p>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

<script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.0/dist/ffmpeg.min.js"></script>

<script>
    const { createFFmpeg, fetchFile } = FFmpeg;
    let ffmpeg = null;
    let selectedFiles = [];

    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('telop-uploader');
    const fileCount = document.getElementById('file-count');

    const updateFileList = (files) => {
        if (!files || files.length === 0) return;
        const newFiles = Array.from(files).filter(f => f.type.startsWith('image/'));
        selectedFiles = newFiles; 
        fileCount.innerText = `âœ… ${selectedFiles.length}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠä¸­`;
    };

    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('dragover'); });
    dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); updateFileList(e.dataTransfer.files); });
    fileInput.addEventListener('change', (e) => { updateFileList(e.target.files); });

    const updateProgress = (percent, text) => {
        const barContainer = document.getElementById('telop-progress-bar');
        const bar = barContainer.firstElementChild;
        barContainer.style.display = 'flex';
        bar.style.width = `${percent}%`;
        if(text) bar.innerText = text;
    };

    const ensureFFmpegLoaded = async () => {
        if (ffmpeg === null) {
            // â˜…é‡è¦ä¿®æ­£: ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯¾ç­–ã¨ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ•´åˆæ€§
            // 1. corePathã®æœ«å°¾ã« `?v=${Date.now()}` ã‚’è¿½åŠ  â†’ æ¯å›å¿…ãšæ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—ã•ã›ã¾ã™(ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ±šæŸ“ã®å›é¿)
            // 2. mainName: 'main' ã‚’ç¶­æŒ â†’ ã‚·ãƒ³ã‚°ãƒ«ã‚¹ãƒ¬ãƒƒãƒ‰ã®å…¥ã‚Šå£ã‚’æ˜ç¤º
            ffmpeg = createFFmpeg({ 
                log: true,
                corePath: `https://unpkg.com/@ffmpeg/core-st@0.11.1/dist/ffmpeg-core.js?v=${Date.now()}`,
                mainName: 'main' 
            });
            await ffmpeg.load();
        } else if (!ffmpeg.isLoaded()) {
            await ffmpeg.load();
        }
    };

    document.getElementById('telop-convert-btn').addEventListener('click', async () => {
        const resultArea = document.getElementById('telop-result-area');
        const btn = document.getElementById('telop-convert-btn');

        if (selectedFiles.length === 0) { alert("ç”»åƒã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã™ã‚‹ã‹ã€é¸æŠã—ã¦ãã ã•ã„"); return; }
        
        btn.disabled = true; btn.innerText = "ç”Ÿæˆä¸­..."; 
        resultArea.innerHTML = '<div class="spinner-border text-warning" role="status"></div><div class="mt-2">ã‚¨ãƒ³ã‚¸ãƒ³èµ·å‹•ä¸­...</div>';
        updateProgress(0, 'æº–å‚™ä¸­...');
        
        try {
            updateProgress(5, 'ã‚¨ãƒ³ã‚¸ãƒ³èª­è¾¼ä¸­(åˆå›ã¯æ•°åˆ†ã‹ã‹ã‚Šã¾ã™)...');
            await new Promise(r => setTimeout(r, 100));
            
            await ensureFFmpegLoaded();
            
            const files = selectedFiles.sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' }));
            const CANVAS_W = 1920; const CANVAS_H = 1080;

            for (let i = 0; i < files.length; i++) {
                const p = 10 + Math.round((i / files.length) * 40);
                updateProgress(p, `ç”»åƒåŠ å·¥ä¸­ ${i+1}/${files.length}`);
                
                let imgBitmap;
                try { imgBitmap = await createImageBitmap(files[i]); } catch(e) { throw new Error(`ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${files[i].name}`); }

                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = CANVAS_W; canvas.height = CANVAS_H;
                
                ctx.fillStyle = '#000000'; ctx.fillRect(0, 0, CANVAS_W, CANVAS_H);

                const scale = Math.min(CANVAS_W / imgBitmap.width, CANVAS_H / imgBitmap.height);
                const drawW = imgBitmap.width * scale; const drawH = imgBitmap.height * scale;
                const offsetX = (CANVAS_W - drawW) / 2; const offsetY = (CANVAS_H - drawH) / 2;

                ctx.drawImage(imgBitmap, offsetX, offsetY, drawW, drawH);
                imgBitmap.close(); 

                const fontSize = 40;
                ctx.font = `bold ${fontSize}px Arial, sans-serif`; ctx.textBaseline = 'top';
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)'; ctx.fillRect(0, 0, CANVAS_W, 60);
                ctx.fillStyle = '#ffffff'; ctx.fillText(`File: ${files[i].name}`, 20, 10);
                
                const blob = await new Promise(r => canvas.toBlob(r, 'image/jpeg', 1.0));
                ffmpeg.FS('writeFile', `img${String(i).padStart(3, '0')}.jpg`, await fetchFile(blob));
            }

            updateProgress(50, 'ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ä¸­...');
            
            await ffmpeg.run('-framerate', '1', '-i', 'img%03d.jpg', '-c:v', 'libx264', '-pix_fmt', 'yuv420p', '-crf', '28', 'output_check.mp4');

            updateProgress(100, 'å®Œäº†');
            const data = ffmpeg.FS('readFile', 'output_check.mp4'); 
            const blob = new Blob([data.buffer], { type: 'video/mp4' }); 
            const url = URL.createObjectURL(blob);
            
            resultArea.innerHTML = `
                <div class="alert alert-success fw-bold">âœ¨ ãƒã‚§ãƒƒã‚¯ç”¨å‹•ç”»å®Œæˆ (1ç§’/æš)</div>
                <video src="${url}" controls class="w-100 mb-3" style="max-height: 300px; background:#000;"></video>
                <div class="mb-4"><a href="${url}" download="telop_check_ai.mp4" class="btn btn-success fw-bold px-5">â¬‡ å‹•ç”»ã‚’ä¿å­˜</a></div>
                <div class="card border-info text-start"><div class="card-header bg-info text-white fw-bold">ğŸš€ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—: AIã§æ ¡æ­£ãƒã‚§ãƒƒã‚¯</div><div class="card-body bg-light"><p class="small text-muted mb-2">ä¿å­˜ã—ãŸå‹•ç”»ã‚’Geminiã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€èª¤å­—è„±å­—ã‚„å›ºæœ‰åè©ã®ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã„ã¾ã—ã‚‡ã†ã€‚</p><a href="https://gemini.google.com/gem/1dN_UBLXFguu4dfD4ZUWab1FV2mc5Jupv?usp=sharing" target="_blank" class="btn btn-outline-primary w-100 fw-bold mb-3">ğŸ¤– æ ¡é–²Geminiã‚’é–‹ã</a></div></div>
            `;
            
            for (let i = 0; i < files.length; i++) { try { ffmpeg.FS('unlink', `img${String(i).padStart(3, '0')}.jpg`); } catch(e){} }
            try { ffmpeg.FS('unlink', 'output_check.mp4'); } catch(e){}
            
        } catch(e) { 
            console.error(e); 
            let msg = e.message;
            if(msg.includes('proxy_main')) msg += '<br>â€»ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«å¤ã„è¨­å®šãŒæ®‹ã£ã¦ã„ã¾ã™ã€‚ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§è©¦ã™ã¨ç¢ºå®Ÿã§ã™ã€‚';
            resultArea.innerHTML = `<div class="alert alert-danger">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:<br>${msg}</div>`;
        }
        
        btn.disabled = false; btn.innerText = "å‹•ç”»ã‚’ä½œæˆ (MP4)";
    });
</script>
</body>
</html>
