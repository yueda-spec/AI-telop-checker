<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ†ãƒ­ãƒƒãƒ—æ ¡æ­£ç”¨PDFä½œæˆãƒ„ãƒ¼ãƒ«</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 p-6">

    <div class="max-w-3xl mx-auto bg-white shadow-lg rounded-lg p-8">
        
        <h1 class="text-2xl font-bold mb-4 text-center">ğŸ“º ãƒ†ãƒ­ãƒƒãƒ—æ ¡æ­£ç”¨PDFä½œæˆãƒ„ãƒ¼ãƒ«</h1>

        <div class="bg-green-50 border-l-4 border-green-500 p-4 mb-6 rounded">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-green-500" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 12a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-green-700 font-bold">
                        ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã«ã¤ã„ã¦ã€‘<br>
                        ã“ã®ãƒ„ãƒ¼ãƒ«ã¯å…¨ã¦ã®å‡¦ç†ã‚’ãŠä½¿ã„ã®PCï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ï¼‰å†…ã§è¡Œã„ã¾ã™ã€‚<br>
                        é¸æŠã—ãŸç”»åƒãƒ‡ãƒ¼ã‚¿ã‚„ç”Ÿæˆã•ã‚ŒãŸPDFãŒå¤–éƒ¨ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã•ã‚Œã‚‹ã“ã¨ã¯ä¸€åˆ‡ã‚ã‚Šã¾ã›ã‚“ã®ã§ã€æ©Ÿå¯†æ€§ã®é«˜ã„ç´ æã§ã‚‚å®‰å¿ƒã—ã¦ã”ä½¿ç”¨ãã ã•ã„ã€‚
                    </p>
                </div>
            </div>
        </div>

        <div class="mb-6">
            <label class="block text-gray-700 text-sm font-bold mb-2" for="fileInput">
                ãƒ†ãƒ­ãƒƒãƒ—ç”»åƒã‚’é¸æŠ (PNGã®ã¿)
            </label>
            <input type="file" id="fileInput" multiple accept="image/png" 
                   class="block w-full text-sm text-gray-500
                          file:mr-4 file:py-2 file:px-4
                          file:rounded-full file:border-0
                          file:text-sm file:font-semibold
                          file:bg-blue-50 file:text-blue-700
                          hover:file:bg-blue-100 cursor-pointer border rounded p-2">
            <p class="text-xs text-gray-500 mt-1">â€»ãƒ•ã‚¡ã‚¤ãƒ«åé †ï¼ˆ1, 2, ... 10ï¼‰ã«è‡ªå‹•ã§ä¸¦ã³æ›¿ãˆã¾ã™ã€‚</p>
        </div>

        <div class="text-center mb-6">
            <button id="generateBtn" onclick="generatePDF()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded shadow disabled:opacity-50 disabled:cursor-not-allowed transition duration-150">
                PDFã‚’ä½œæˆã™ã‚‹
            </button>
            <div id="status" class="mt-2 text-sm text-gray-600 hidden">
                <div class="loader mr-2"></div>å‡¦ç†ä¸­... (<span id="progressCount">0</span>/<span id="totalCount">0</span>)
            </div>
        </div>

        <hr class="my-6 border-gray-200">

        <div id="resultArea" class="hidden text-center bg-gray-100 p-6 rounded-lg">
            <h2 class="text-lg font-bold mb-4 text-gray-800">ğŸ‰ PDFä½œæˆå®Œäº†</h2>
            
            <p class="mb-4 text-sm text-gray-600">
                PDFãŒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸã€‚<br>
                ä»¥ä¸‹ã®ãƒœã‚¿ãƒ³ã‹ã‚‰æ ¡é–²ç”¨Geminiã‚’é–‹ãã€PDFã‚’æ·»ä»˜ã—ã¦Enterã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚
            </p>

            <a href="https://gemini.google.com/gem/1dN_UBLXFguu4dfD4ZUWab1FV2mc5Jupv?usp=sharing" target="_blank" 
               class="inline-flex items-center bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-bold py-3 px-6 rounded shadow-lg transform transition hover:-translate-y-1">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                æ ¡é–²ç”¨Gemini (GEM) ã‚’é–‹ã
            </a>
        </div>

        <div class="mt-8 bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm leading-5 font-bold text-yellow-800">å¿…ãšã”ç¢ºèªãã ã•ã„</h3>
                    <ul class="list-disc list-inside text-sm text-yellow-700 mt-1">
                        <li><strong>éŸ³å£°ãƒã‚§ãƒƒã‚¯ã¯ã§ãã¾ã›ã‚“ï¼š</strong> ãƒ†ãƒ­ãƒƒãƒ—ã®å†…å®¹ãŒè©±ã—ã¦ã„ã‚‹è¨€è‘‰ã¨ä¸€è‡´ã—ã¦ã„ã‚‹ã‹ã®ç¢ºèªï¼ˆONãƒ•ã‚©ãƒ­ãƒ¼ç¢ºèªï¼‰ã¯ã§ãã¾ã›ã‚“ã€‚</li>
                        <li><strong>ãƒ€ãƒ–ãƒ«ãƒã‚§ãƒƒã‚¯å¿…é ˆï¼š</strong> AIã¯èª¤ã£ãŸæŒ‡æ‘˜ã‚„è¦‹è½ã¨ã—ã‚’ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚æœ€çµ‚çš„ãªç¢ºèªã¯å¿…ãšäººé–“ãŒè¡Œã£ã¦ãã ã•ã„ã€‚</li>
                    </ul>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { jsPDF } = window.jspdf;

        async function generatePDF() {
            const fileInput = document.getElementById('fileInput');
            const statusDiv = document.getElementById('status');
            const progressCount = document.getElementById('progressCount');
            const totalCount = document.getElementById('totalCount');
            const generateBtn = document.getElementById('generateBtn');
            const resultArea = document.getElementById('resultArea');

            const files = Array.from(fileInput.files);

            if (files.length === 0) {
                alert("ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
                return;
            }

            // UIæ›´æ–°
            generateBtn.disabled = true;
            resultArea.classList.add('hidden');
            statusDiv.classList.remove('hidden');
            totalCount.innerText = files.length;
            progressCount.innerText = 0;

            try {
                // ãƒ•ã‚¡ã‚¤ãƒ«åé †ï¼ˆè‡ªç„¶é †ï¼‰ã«ã‚½ãƒ¼ãƒˆ (1, 2, ... 10)
                const collator = new Intl.Collator(undefined, {numeric: true, sensitivity: 'base'});
                files.sort((a, b) => collator.compare(a.name, b.name));

                // PDFãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆ
                const pdf = new jsPDF({
                    orientation: 'landscape',
                    unit: 'px',
                    compress: true
                });
                
                // æœ€åˆã®ãƒšãƒ¼ã‚¸ã‚’å‰Šé™¤ï¼ˆå¾Œã§è¿½åŠ ã™ã‚‹ãŸã‚ï¼‰
                pdf.deletePage(1);

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    progressCount.innerText = i + 1;

                    // ç”»åƒã‚’èª­ã¿è¾¼ã‚€
                    const imgData = await readFileAsDataURL(file);
                    const img = await loadImage(imgData);

                    // Canvasã§ç”»åƒã‚’åˆæˆ
                    const mergedImage = drawToCanvas(img, file.name);

                    // PDFã«è¿½åŠ 
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    
                    // ãƒšãƒ¼ã‚¸ã‚µã‚¤ã‚ºã‚’ç”»åƒã‚µã‚¤ã‚ºã«åˆã‚ã›ã‚‹
                    pdf.addPage([mergedImage.width, mergedImage.height], mergedImage.width > mergedImage.height ? 'landscape' : 'portrait');
                    
                    // ç”»åƒã‚’PDFãƒšãƒ¼ã‚¸å…¨é¢ã«é…ç½®
                    pdf.addImage(mergedImage.data, 'JPEG', 0, 0, mergedImage.width, mergedImage.height);
                }

                // ä¿å­˜
                const timestamp = new Date().toISOString().slice(0,19).replace(/[-T:]/g,"");
                pdf.save(`terop_check_${timestamp}.pdf`);

                // å®Œäº†è¡¨ç¤º
                resultArea.classList.remove('hidden');

            } catch (err) {
                console.error(err);
                alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + err.message);
            } finally {
                generateBtn.disabled = false;
                statusDiv.classList.add('hidden');
            }
        }

        // Canvasæç”»å‡¦ç†
        function drawToCanvas(img, fileName) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            // --- è¨­å®šå€¤ ---
            const baseWidth = img.width; // ç”»åƒã®å¹…ã«åˆã‚ã›ã‚‹
            const fontSize = Math.max(24, Math.floor(baseWidth / 40)); // å¹…ã«å¿œã˜ã¦ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºèª¿æ•´
            const padding = fontSize; // ä½™ç™½
            const lineHeight = fontSize * 1.5;
            
            // --- ãƒ†ã‚­ã‚¹ãƒˆã®æŠ˜ã‚Šè¿”ã—è¨ˆç®— ---
            ctx.font = `bold ${fontSize}px sans-serif`;
            const maxWidth = baseWidth - (padding * 2);
            const lines = wrapText(ctx, fileName, maxWidth);
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼ã®é«˜ã•ã‚’è¨ˆç®—
            const headerHeight = (lines.length * lineHeight) + (padding * 2);
            const totalHeight = headerHeight + img.height;

            // Canvasã‚µã‚¤ã‚ºæ±ºå®š
            canvas.width = baseWidth;
            canvas.height = totalHeight;

            // 1. ãƒ˜ãƒƒãƒ€ãƒ¼æç”»ï¼ˆé»’èƒŒæ™¯ï¼‰
            ctx.fillStyle = "#000000";
            ctx.fillRect(0, 0, baseWidth, headerHeight);

            // 2. ãƒ•ã‚¡ã‚¤ãƒ«åæç”»ï¼ˆç™½æ–‡å­—ï¼‰
            ctx.fillStyle = "#FFFFFF";
            ctx.font = `bold ${fontSize}px sans-serif`;
            ctx.textBaseline = "top";
            
            let currentY = padding;
            lines.forEach(line => {
                ctx.fillText(line, padding, currentY);
                currentY += lineHeight;
            });

            // 3. ãƒ†ãƒ­ãƒƒãƒ—ã‚¨ãƒªã‚¢æç”»ï¼ˆè–„ã„ã‚°ãƒ¬ãƒ¼èƒŒæ™¯ï¼‰
            ctx.fillStyle = "#D3D3D3"; // LightGray
            ctx.fillRect(0, headerHeight, baseWidth, img.height);

            // 4. ãƒ†ãƒ­ãƒƒãƒ—ç”»åƒæç”»
            ctx.drawImage(img, 0, headerHeight);

            return {
                // ä¿®æ­£ç®‡æ‰€: AIèªè­˜ç²¾åº¦å‘ä¸Šã®ãŸã‚å“è³ªã‚’0.85ã‹ã‚‰0.95ã¸å¤‰æ›´
                data: canvas.toDataURL('image/jpeg', 0.95), 
                width: canvas.width,
                height: canvas.height
            };
        }

        // ãƒ†ã‚­ã‚¹ãƒˆæŠ˜ã‚Šè¿”ã—è¨ˆç®—ç”¨é–¢æ•°
        function wrapText(ctx, text, maxWidth) {
            const words = text.split(''); // æ–‡å­—å˜ä½ã§åˆ†å‰²ï¼ˆæ—¥æœ¬èªå¯¾å¿œï¼‰
            let lines = [];
            let currentLine = words[0];

            for (let i = 1; i < words.length; i++) {
                let word = words[i];
                let width = ctx.measureText(currentLine + word).width;
                if (width < maxWidth) {
                    currentLine += word;
                } else {
                    lines.push(currentLine);
                    currentLine = word;
                }
            }
            lines.push(currentLine);
            return lines;
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ãƒ˜ãƒ«ãƒ‘ãƒ¼
        function readFileAsDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // ç”»åƒèª­ã¿è¾¼ã¿ãƒ˜ãƒ«ãƒ‘ãƒ¼
        function loadImage(src) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = reject;
                img.src = src;
            });
        }
    </script>
</body>
</html>
